{% extends 'app/base.html' %}
{% load static %}

{% block title %}Secure Payment{% endblock %}

{% block main-content %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-dark text-white text-center">
                    <h4>üîí Secure Payment</h4>
                </div>
                <div class="card-body">
                    <h5>Order Summary</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal:</span><strong>‚Çπ{{ subtotal|floatformat:2 }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Delivery:</span><strong>‚Çπ40</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <strong>Total:</strong><strong class="text-success">‚Çπ{{ totalamount|floatformat:2 }}</strong>
                        </li>
                    </ul>
                    <button id="pay-button" class="btn btn-success w-100 fw-bold">
                        üí≥ Pay Now - ‚Çπ{{ totalamount|floatformat:2 }}
                    </button>
                </div>
                <div class="card-footer text-center">
                    <small>Secured by <strong>Razorpay</strong></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const options = {
        key: "{{ razorpay_key }}", // Razorpay Key ID
        amount: "{{ razorpay_amount }}", // Amount in paise
        currency: "INR",
        name: "NEEL",
        description: "Secure Payment for your Order",
        order_id: "{{ order_id }}", // Razorpay Order ID
        handler: function (response) {
            fetch("/verify_payment/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ Payment Verified");
                    window.location.href = "/payment_success/";
                } else {
                    alert("‚ùå Payment verification failed.");
                    window.location.reload();
                }
            })
            .catch(err => {
                console.error("Verification Error:", err);
                alert("‚ùå Server error. Please try again.");
            });
        },
        theme: {
            color: "#4CAF50"
        }
    };

    const rzp = new Razorpay(options);
    document.getElementById("pay-button").onclick = function (e) {
        rzp.open();
        e.preventDefault();
    };
</script>
{% endblock %}
